import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plus, Heart, History, TrendingUp, Coffee, Trash2, Leaf, Star, 
  X, Download, Sparkles, Wallet, BarChart3, LayoutGrid, Table as TableIcon
} from 'lucide-react';
import { 
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, 
  ResponsiveContainer, PieChart, Pie, Cell, BarChart, Bar 
} from 'recharts';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, collection, addDoc, onSnapshot, query, 
  deleteDoc, doc 
} from 'firebase/firestore';

// --- Firebase é…ç½® ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'drink-tracker-2026';

const ECO_CUP_OFFSET = 25; // 2025 å¹´ç´¯ç©æ¬¡æ•¸
const ECO_SAVING_PER_CUP = 5;
const ICE_OPTIONS = ['å°‘å†°', 'å¾®å†°', 'å»å†°', 'ç†±'];
const SUGAR_OPTIONS = ['ä¸å¯èª¿', 'å¾®ç³–', 'ä¸€åˆ†ç³–', 'ç„¡ç³–'];
const CANDY_COLORS = ['#fb7185', '#f472b6', '#c084fc', '#FFDC35', '#f87171', '#fbbf24'];

const App = () => {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('record'); // record, history, stats
  const [historyMode, setHistoryMode] = useState('card');
  const [drinks, setDrinks] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [loading, setLoading] = useState(true);

  // è¡¨å–®ç‹€æ…‹
  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0],
    shop: '',
    item: '',
    price: '',
    ice: 'å¾®å†°',
    sugar: 'ç„¡ç³–',
    isEcoCup: false
  });

  // --- 1. åˆå§‹åŒ– Auth ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("é©—è­‰éŒ¯èª¤:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
    });
    return () => unsubscribe();
  }, []);

  // --- 2. ç›£è½ Firestore æ•¸æ“š ---
  useEffect(() => {
    if (!user) return;

    const drinksRef = collection(db, 'artifacts', appId, 'public', 'data', 'drinks');
    const unsubDrinks = onSnapshot(query(drinksRef), (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setDrinks(data.sort((a, b) => new Date(b.date) - new Date(a.date)));
      setLoading(false);
    }, (err) => {
      console.error("è®€å–ç´€éŒ„å¤±æ•—:", err);
      setLoading(false);
    });

    const favsRef = collection(db, 'artifacts', appId, 'public', 'data', 'favorites');
    const unsubFavs = onSnapshot(query(favsRef), (snap) => {
      setFavorites(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    }, (err) => console.error("è®€å–æœ€æ„›å¤±æ•—:", err));

    return () => {
      unsubDrinks();
      unsubFavs();
    };
  }, [user]);

  // --- é‚è¼¯è¨ˆç®— ---
  const stats = useMemo(() => {
    const ecoList = drinks.filter(d => d.isEcoCup);
    const totalSpent = drinks.reduce((sum, d) => sum + (Number(d.finalPrice) || 0), 0);
    
    const monthlyDataMap = {};
    drinks.forEach(d => {
      const m = d.date.substring(0, 7);
      monthlyDataMap[m] = (monthlyDataMap[m] || 0) + (Number(d.finalPrice) || 0);
    });
    const monthlySpending = Object.entries(monthlyDataMap)
      .map(([name, value]) => ({ name, value }))
      .sort((a, b) => a.name.localeCompare(b.name));

    const sugarMap = drinks.reduce((acc, d) => ({...acc, [d.sugar]: (acc[d.sugar] || 0) + 1}), {});
    const sugarDist = Object.entries(sugarMap).map(([name, value]) => ({ name, value }));

    const shopMap = drinks.reduce((acc, d) => ({...acc, [d.shop]: (acc[d.shop] || 0) + 1}), {});
    const topShops = Object.entries(shopMap)
      .map(([name, value]) => ({ name, value }))
      .sort((a, b) => b.value - a.value)
      .slice(0, 5);

    return {
      totalEcoCount: ecoList.length + ECO_CUP_OFFSET,
      totalSavings: (ecoList.length + ECO_CUP_OFFSET) * ECO_SAVING_PER_CUP,
      totalSpent,
      monthlySpending,
      sugarDist,
      topShops,
      totalCups: drinks.length
    };
  }, [drinks]);

  // --- å‹•ä½œè™•ç† ---
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user || !formData.shop || !formData.item || !formData.price) return;

    const finalPrice = Number(formData.price);
    
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'drinks'), {
        ...formData,
        originalPrice: formData.isEcoCup ? finalPrice + 5 : finalPrice,
        finalPrice,
        createdAt: new Date().toISOString()
      });
      setFormData({ ...formData, shop: '', item: '', price: '', isEcoCup: false });
      setView('history');
    } catch (err) {
      console.error("å„²å­˜å¤±æ•—:", err);
    }
  };

  const handleAddFavorite = async () => {
    if (!user || !formData.shop || !formData.item) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'favorites'), {
        shop: formData.shop,
        item: formData.item,
        price: formData.price,
        ice: formData.ice,
        sugar: formData.sugar,
        isEcoCup: formData.isEcoCup
      });
    } catch (err) {
      console.error("å„²å­˜æœ€æ„›å¤±æ•—:", err);
    }
  };

  const useFavorite = (fav) => {
    setFormData({
      ...formData,
      shop: fav.shop,
      item: fav.item,
      price: fav.price || '',
      ice: fav.ice || 'å¾®å†°',
      sugar: fav.sugar || 'ç„¡ç³–',
      isEcoCup: fav.isEcoCup || false,
      date: new Date().toISOString().split('T')[0]
    });
    setView('record');
  };

  const deleteDrink = async (id) => {
    if (!user) return;
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†å¥½å¿ƒæƒ…å—ï¼Ÿ")) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'drinks', id));
  };

  const deleteFavorite = async (id) => {
    if (!user) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'favorites', id));
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-[#fce7f3] flex flex-col items-center justify-center gap-6">
        <div className="text-6xl animate-bounce">ğŸ§‹</div>
        <div className="text-[#fb7185] font-black text-2xl tracking-widest animate-pulse">
          æ­£åœ¨æº–å‚™æ‚¨çš„æ‰‹æ–å°æœ¬æœ¬...
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#fce7f3] text-[#FFFFFF] pb-24 font-black selection:bg-[#FFDC35] selection:text-pink-600">
      {/* Header */}
      <header className="bg-[#fb7185] border-b-[10px] border-[#d94a63] sticky top-0 z-20 p-6 rounded-b-[40px] shadow-lg">
        <div className="max-w-xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-3 text-2xl drop-shadow-[2px_2px_0_rgba(0,0,0,0.1)]">
            <span className="text-3xl">ğŸ§‹</span>
            2026 æ‰‹æ–ç´€éŒ„å™¨
          </div>
          <button 
            onClick={() => setView('record')}
            className="bg-white border-[4px] border-[#fb7185] p-3 rounded-2xl text-[#fb7185] shadow-[4px_4px_0_0_#fb7185] active:translate-y-1 active:shadow-none transition-all"
          >
            <Plus size={24} strokeWidth={4} />
          </button>
        </div>
      </header>

      <main className="max-w-xl mx-auto p-4 space-y-10 mt-6">
        
        {/* å°èˆªåˆ†é  */}
        <div className="flex bg-[#fb7185] p-2 rounded-[35px] border-[6px] border-white shadow-[8px_8px_0_0_rgba(217,74,99,0.3)]">
          {[
            { id: 'record', icon: <Plus size={20}/>, label: 'è¨˜ä¸€ç­†' },
            { id: 'history', icon: <History size={20}/>, label: 'æ­·å²' },
            { id: 'stats', icon: <BarChart3 size={20}/>, label: 'åˆ†æ' }
          ].map(tab => {
            const isActive = view === tab.id;
            // åªæœ‰ã€Œåˆ†æã€é¸ä¸­æ™‚ä½¿ç”¨é»ƒè‰²ï¼Œå…¶ä»–ä½¿ç”¨ç™½è‰²èƒŒæ™¯
            const activeClass = tab.id === 'stats' 
              ? 'bg-[#FFDC35] text-pink-700' 
              : 'bg-white text-[#fb7185]';
            
            return (
              <button 
                key={tab.id} 
                onClick={() => setView(tab.id)} 
                className={`flex-1 py-4 rounded-[28px] transition-all flex items-center justify-center gap-2 font-black ${isActive ? `${activeClass} shadow-md scale-105` : 'text-white/70 hover:text-white'}`}
              >
                {tab.icon}
                {tab.label}
              </button>
            );
          })}
        </div>

        {/* å…§å®¹å€åŸŸ */}
        {view === 'record' && (
          <div className="space-y-8 animate-in zoom-in duration-300">
            
            {/* æœ€æ„›çµ„åˆ */}
            {favorites.length > 0 && (
              <div className="space-y-4">
                <h2 className="text-[#fb7185] ml-4 flex items-center gap-2 uppercase text-sm tracking-widest drop-shadow-[1px_1px_0_white]">
                  <Star size={16} className="fill-[#FFDC35] text-[#FFDC35]" /> æœ€æ„›çµ„åˆ
                </h2>
                <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar px-2">
                  {favorites.map(fav => (
                    <div key={fav.id} className="relative group flex-shrink-0">
                      <button
                        onClick={() => useFavorite(fav)}
                        className="bg-white px-8 py-4 rounded-[25px] border-[5px] border-[#fb7185] text-sm shadow-[5px_5px_0_0_#fb7185] hover:translate-y-1 hover:shadow-none transition-all flex items-center gap-3"
                      >
                        <span className="text-[#fb7185] font-black">{fav.shop}</span>
                        <span className="text-gray-500">{fav.item}</span>
                      </button>
                      <button 
                        onClick={() => deleteFavorite(fav.id)}
                        className="absolute -top-2 -right-2 bg-red-500 text-white p-2 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-all"
                      >
                        <X size={12} strokeWidth={4} />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* è¼¸å…¥è¡¨å–® */}
            <form onSubmit={handleSubmit} className="bg-[#fb7185] rounded-[50px] shadow-[12px_12px_0_0_rgba(217,74,99,0.3)] p-10 border-[8px] border-white space-y-8">
              <div className="grid grid-cols-2 gap-8">
                <div className="space-y-3">
                  <label className="text-white ml-2 uppercase text-xs tracking-widest opacity-95">æ—¥æœŸ ğŸ“…</label>
                  <input 
                    type="date" 
                    required 
                    value={formData.date} 
                    onChange={e => setFormData({...formData, date: e.target.value})} 
                    className="w-full p-5 rounded-[25px] bg-white text-pink-600 border-[5px] border-transparent focus:border-[#FFDC35] outline-none transition-all shadow-inner" 
                  />
                </div>
                <div className="space-y-3">
                  <label className="text-white ml-2 uppercase text-xs tracking-widest opacity-95">å¯¦ä»˜é‡‘é¡ ğŸ’°</label>
                  <input 
                    type="number" 
                    required 
                    placeholder="å¤šå°‘éŒ¢"
                    value={formData.price} 
                    onChange={e => setFormData({...formData, price: e.target.value})} 
                    className="w-full p-5 rounded-[25px] bg-white text-pink-600 border-[5px] border-transparent focus:border-[#FFDC35] outline-none transition-all shadow-inner font-black" 
                  />
                </div>
              </div>

              <div className="space-y-3">
                <label className="text-white ml-2 uppercase text-xs tracking-widest opacity-95">åº—å®¶ ğŸª</label>
                <input 
                  type="text" 
                  required 
                  placeholder="åº—å..." 
                  value={formData.shop} 
                  onChange={e => setFormData({...formData, shop: e.target.value})} 
                  className="w-full p-6 rounded-[30px] bg-white text-pink-600 border-[5px] border-transparent focus:border-[#FFDC35] outline-none transition-all text-lg shadow-inner" 
                />
              </div>

              <div className="space-y-3">
                <label className="text-white ml-2 uppercase text-xs tracking-widest opacity-95">é£²å“ ğŸ¥¤</label>
                <input 
                  type="text" 
                  required 
                  placeholder="å“é …..." 
                  value={formData.item} 
                  onChange={e => setFormData({...formData, item: e.target.value})} 
                  className="w-full p-6 rounded-[30px] bg-white text-pink-600 border-[5px] border-transparent focus:border-[#FFDC35] outline-none transition-all text-lg shadow-inner" 
                />
              </div>

              <div className="space-y-4">
                <label className="text-white ml-2 text-xs tracking-widest opacity-95">å†°å¡Š ğŸ§Š</label>
                <div className="flex flex-wrap gap-4">
                  {ICE_OPTIONS.map(o => (
                    <button 
                      key={o} 
                      type="button" 
                      onClick={() => setFormData({...formData, ice: o})} 
                      className={`px-8 py-4 rounded-[20px] text-sm border-b-[8px] transition-all ${formData.ice === o ? 'bg-white text-[#fb7185] border-pink-200 shadow-lg translate-y-1' : 'bg-white/20 text-white border-transparent hover:bg-white/30 hover:scale-105'}`}
                    >
                      {o}
                    </button>
                  ))}
                </div>
              </div>

              <div className="space-y-4">
                <label className="text-white ml-2 text-xs tracking-widest opacity-95">ç”œåº¦ ğŸ¬</label>
                <div className="flex flex-wrap gap-4">
                  {SUGAR_OPTIONS.map(o => (
                    <button 
                      key={o} 
                      type="button" 
                      onClick={() => setFormData({...formData, sugar: o})} 
                      className={`px-8 py-4 rounded-[20px] text-sm border-b-[8px] transition-all ${formData.sugar === o ? 'bg-white text-[#fb7185] border-pink-200 shadow-lg translate-y-1' : 'bg-white/20 text-white border-transparent hover:bg-white/30 hover:scale-105'}`}
                    >
                      {o}
                    </button>
                  ))}
                </div>
              </div>

              <div 
                onClick={() => setFormData({...formData, isEcoCup: !formData.isEcoCup})} 
                className={`p-8 rounded-[40px] flex items-center justify-between cursor-pointer transition-all border-[6px] ${formData.isEcoCup ? 'bg-emerald-500 border-white shadow-lg scale-[1.02]' : 'bg-white/10 border-transparent'}`}
              >
                <div className="flex items-center gap-5">
                  <div className={`p-5 rounded-[25px] shadow-md ${formData.isEcoCup ? 'bg-white text-emerald-500' : 'bg-white/20 text-white'}`}>
                    <Leaf size={28} strokeWidth={3} />
                  </div>
                  <div>
                    <div className="text-xl text-white">ç’°ä¿æ¯æ„›åœ°çƒ</div>
                    <div className="text-xs text-white/80">æ­¤ç­†å·²äº«æŠ˜åƒ¹ $5</div>
                  </div>
                </div>
                <div className={`w-12 h-12 rounded-full border-[6px] flex items-center justify-center transition-all ${formData.isEcoCup ? 'bg-white border-white shadow-lg' : 'border-white/30 bg-transparent'}`}>
                  {formData.isEcoCup && <div className="w-5 h-5 bg-emerald-500 rounded-full" />}
                </div>
              </div>

              <div className="flex gap-6 pt-4">
                <button 
                  type="button"
                  onClick={handleAddFavorite}
                  className="flex-1 bg-white text-[#fb7185] py-7 rounded-[35px] text-xl border-[6px] border-[#FFDC35] shadow-[6px_6px_0_0_#FFDC35] active:translate-y-1 active:shadow-none transition-all flex items-center justify-center gap-2"
                >
                  <Star className="fill-[#FFDC35] text-[#FFDC35]" />
                  åŠ æœ€æ„›
                </button>
                <button 
                  type="submit" 
                  className="flex-[2] bg-[#fb7185] text-white py-7 rounded-[35px] text-2xl shadow-[0_12px_0_0_#d94a63] border-white border-[6px] active:translate-y-2 active:shadow-none transition-all flex items-center justify-center gap-3"
                >
                  è¨˜éŒ„é€™ä¸€æ¯ <Sparkles size={24} />
                </button>
              </div>
            </form>
          </div>
        )}

        {view === 'history' && (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-6 duration-500">
            <div className="flex justify-between items-center px-4">
              <span className="text-[#fb7185] text-sm drop-shadow-[1px_1px_0_white]">å…± {stats.totalCups} æ¯ç´€éŒ„</span>
              <button 
                onClick={() => setHistoryMode(historyMode === 'card' ? 'table' : 'card')} 
                className="bg-[#fb7185] px-6 py-4 rounded-3xl text-sm text-white border-[5px] border-white shadow-[5px_5px_0_0_#fb7185] flex items-center gap-3 active:translate-y-1 active:shadow-none transition-all"
              >
                {historyMode === 'card' ? <TableIcon size={18} /> : <LayoutGrid size={18} />}
                {historyMode === 'card' ? 'è¡¨æ ¼æ¨¡å¼' : 'å¡ç‰‡æ¨¡å¼'}
              </button>
            </div>

            {drinks.length === 0 ? (
              <div className="text-center py-24 bg-white/40 rounded-[50px] border-[10px] border-dashed border-white text-pink-300 italic">
                å°šæœªé–‹å•Ÿç¬¬ä¸€å£ç¾å‘³ ğŸ§‹
              </div>
            ) : historyMode === 'card' ? (
              <div className="space-y-6">
                {drinks.map(d => (
                  <div key={d.id} className="bg-[#fb7185] p-8 rounded-[45px] shadow-[10px_10px_0_0_rgba(217,74,99,0.3)] border-[6px] border-white flex justify-between items-center group hover:scale-[1.02] transition-all relative overflow-hidden">
                    <div className="space-y-4 relative z-10">
                      <div className="flex items-center gap-3 text-[12px]">
                        <span className="bg-white text-[#fb7185] px-4 py-1.5 rounded-full shadow-sm">{d.date}</span>
                        {d.isEcoCup && <span className="bg-[#FFDC35] text-pink-800 px-4 py-1.5 rounded-full flex items-center gap-2 shadow-sm font-black"><Leaf size={12} /> ECO</span>}
                      </div>
                      <div className="text-2xl drop-shadow-sm">{d.shop} <span className="text-pink-200 mx-1">â˜…</span> {d.item}</div>
                      <div className="flex gap-3 text-white/95">
                        <span className="bg-white/25 px-4 py-1.5 rounded-2xl text-[12px]">{d.sugar}</span>
                        <span className="bg-white/25 px-4 py-1.5 rounded-2xl text-[12px]">{d.ice}</span>
                        <span className="bg-[#FFDC35] text-pink-800 px-4 py-1.5 rounded-2xl text-[14px] font-black shadow-sm">${d.finalPrice}</span>
                      </div>
                    </div>
                    <button 
                      onClick={() => deleteDrink(d.id)} 
                      className="p-5 text-white/40 hover:text-white hover:bg-white/20 rounded-full transition-all opacity-0 group-hover:opacity-100"
                    >
                      <Trash2 size={24} />
                    </button>
                    {d.isEcoCup && <div className="absolute -right-6 -bottom-6 text-white opacity-10 rotate-12 scale-150"><Leaf size={100} /></div>}
                  </div>
                ))}
              </div>
            ) : (
              <div className="bg-[#fb7185] rounded-[45px] shadow-[10px_10px_0_0_rgba(217,74,99,0.3)] border-[8px] border-white overflow-hidden overflow-x-auto">
                <table className="w-full text-left text-sm">
                  <thead className="bg-white/10 text-white font-black border-b-[4px] border-white/20">
                    <tr>
                      <th className="p-5 uppercase tracking-wider">æ—¥æœŸ</th>
                      <th className="p-5">åº—å®¶</th>
                      <th className="p-5">é£²å“</th>
                      <th className="p-5">å¯¦ä»˜</th>
                      <th className="p-5">Eco</th>
                      <th className="p-5"></th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-white/10">
                    {drinks.map(d => (
                      <tr key={d.id} className="hover:bg-white/10 transition-colors">
                        <td className="p-5 text-pink-100">{d.date.substring(5)}</td>
                        <td className="p-5">{d.shop}</td>
                        <td className="p-5 font-bold">{d.item}</td>
                        <td className="p-5 text-[#FFDC35] font-black text-lg drop-shadow-sm">${d.finalPrice}</td>
                        <td className="p-5 text-lg">{d.isEcoCup ? 'âœ…' : 'âŒ'}</td>
                        <td className="p-5 text-right">
                          <button onClick={() => deleteDrink(d.id)} className="text-white/40 hover:text-white transition-colors p-2"><Trash2 size={16}/></button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {view === 'stats' && (
          <div className="space-y-10 animate-in fade-in duration-500">
            {/* å¿«é€Ÿæ•¸æ“š */}
            <div className="grid grid-cols-2 gap-8">
              <div className="bg-[#FFDC35] p-10 rounded-[50px] shadow-[10px_10px_0_0_#c4a621] relative overflow-hidden group text-pink-800 border-[6px] border-white">
                <Leaf className="absolute -right-4 -top-4 opacity-20 w-28 h-28 rotate-12 group-hover:scale-110 transition-transform" />
                <div className="text-5xl mb-2 font-black tracking-tighter">{stats.totalEcoCount} æ¬¡</div>
                <div className="text-sm opacity-80 uppercase tracking-widest font-bold">ç’°ä¿é‡Œç¨‹ç¢‘</div>
                <div className="text-[12px] font-black opacity-60 mt-2">ç´¯ç©çœä¸‹: ${stats.totalSavings}</div>
                <div className="mt-5 text-[10px] bg-white/40 backdrop-blur-md px-5 py-2.5 rounded-full border border-pink-200 inline-block font-black shadow-sm">
                   2025 å¹´åº•æ•¸: 25 æ¬¡
                </div>
              </div>
              <div className="bg-[#fb7185] p-10 rounded-[50px] shadow-[10px_10px_0_0_rgba(217,74,99,0.3)] border-[6px] border-white text-white flex flex-col items-center justify-center text-center">
                <div className="bg-white/20 p-5 rounded-[25px] mb-4 text-white shadow-inner">
                  <Wallet size={32} strokeWidth={2.5} />
                </div>
                <div className="text-4xl text-white mb-1 tracking-tighter drop-shadow-lg font-black">${stats.totalSpent}</div>
                <div className="text-xs text-white/90 uppercase tracking-widest font-bold">2026 ç¸½èŠ±è²»</div>
              </div>
            </div>

            {/* æ¯æœˆè¶¨å‹¢åœ– */}
            <div className="bg-white p-10 rounded-[50px] shadow-[10px_10px_0_0_rgba(0,0,0,0.05)] border-[8px] border-[#fb7185]/10 h-96">
              <h3 className="text-xs text-[#fb7185] mb-10 uppercase tracking-widest flex items-center gap-3 font-black">
                <TrendingUp size={20} /> æ”¯å‡ºè¶¨å‹¢åœ– ğŸ“ˆ
              </h3>
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={stats.monthlySpending}>
                  <CartesianGrid strokeDasharray="6 6" vertical={false} stroke="#fce7f3" />
                  <XAxis 
                    dataKey="name" 
                    tick={{fontSize:12, fontWeight:900, fill:'#fb7185'}} 
                    axisLine={false} 
                    tickLine={false} 
                  />
                  <YAxis 
                    tick={{fontSize:12, fontWeight:900, fill:'#fb7185'}} 
                    axisLine={false} 
                    tickLine={false} 
                  />
                  <Tooltip 
                    contentStyle={{borderRadius: '30px', border: 'none', boxShadow: '0 20px 30px -10px rgba(251,113,133,0.3)', padding: '20px', fontWeight: 900}} 
                  />
                  <Line 
                    type="monotone" 
                    dataKey="value" 
                    stroke="#FFDC35" 
                    strokeWidth={10} 
                    dot={{r:10, fill:'#FFDC35', strokeWidth:5, stroke:'#fff'}} 
                    activeDot={{r:14, strokeWidth:0}} 
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>

            {/* åœ“é¤…åœ–èˆ‡é•·æ¢åœ– */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
              <div className="bg-white p-10 rounded-[50px] shadow-[10px_10px_0_0_rgba(0,0,0,0.05)] border-[8px] border-[#fb7185]/10 h-80 flex flex-col">
                <h3 className="text-[12px] text-[#fb7185] mb-6 uppercase tracking-widest text-center font-black">ç”œåº¦æ¯”ä¾‹ ğŸ¬</h3>
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie data={stats.sugarDist} dataKey="value" innerRadius={60} outerRadius={85} paddingAngle={10}>
                      {stats.sugarDist.map((_, i) => (
                        <Cell key={i} fill={CANDY_COLORS[i % CANDY_COLORS.length]} stroke="none" />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
                <div className="flex flex-wrap justify-center gap-x-5 gap-y-2 mt-4 text-[11px] text-[#fb7185]">
                  {stats.sugarDist.map((e, i) => (
                    <div key={e.name} className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full shadow-sm" style={{background: CANDY_COLORS[i % CANDY_COLORS.length]}}></div>
                      {e.name}
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-white p-10 rounded-[50px] shadow-[10px_10px_0_0_rgba(0,0,0,0.05)] border-[8px] border-[#fb7185]/10 h-80">
                <h3 className="text-[12px] text-[#fb7185] mb-6 uppercase tracking-widest text-center font-black">æœ€å¸¸é»åº—å®¶ ğŸ†</h3>
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart layout="vertical" data={stats.topShops}>
                    <XAxis type="number" hide />
                    <YAxis 
                      dataKey="name" 
                      type="category" 
                      width={90} 
                      tick={{fontSize:12, fontWeight:900, fill:'#fb7185'}} 
                      axisLine={false} 
                      tickLine={false} 
                    />
                    <Bar dataKey="value" fill="#FFDC35" radius={[0, 20, 20, 0]} barSize={35} />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="pt-10 flex flex-col items-center gap-5 pb-10">
              <button 
                onClick={() => {
                  const dataStr = JSON.stringify(drinks);
                  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                  const link = document.createElement('a');
                  link.href = dataUri;
                  link.download = `æ‰‹æ–ç´€éŒ„å‚™ä»½_2026.json`;
                  link.click();
                }} 
                className="flex items-center gap-4 px-12 py-6 bg-white text-[#fb7185] rounded-[30px] font-black text-sm hover:translate-y-1 transition-all shadow-[6px_6px_0_0_#FFDC35] border-[5px] border-[#FFDC35]"
              >
                <Download size={20} strokeWidth={3} />
                å°å‡ºè³‡æ–™å‚™ä»½ (.json)
              </button>
              <p className="text-xs text-[#fb7185] font-black opacity-80">è³‡æ–™å·²æ°¸ä¹…åŒæ­¥è‡³é›²ç«¯å›‰ï¼âœ¨</p>
            </div>
          </div>
        )}
      </main>

      {/* æ‡¸æµ®æŒ‰éˆ• */}
      {view !== 'record' && (
        <button 
          onClick={() => setView('record')} 
          className="fixed bottom-10 right-10 w-28 h-28 bg-white text-[#fb7185] rounded-full shadow-[10px_10px_0_0_rgba(251,113,133,0.3)] flex items-center justify-center border-[8px] border-[#FFDC35] active:translate-y-2 active:shadow-none transition-all z-30 group"
        >
          <div className="relative">
            <Plus size={48} strokeWidth={4} />
            <span className="absolute -top-14 left-1/2 -translate-x-1/2 text-6xl group-hover:-translate-y-4 transition-transform drop-shadow-2xl">ğŸ§‹</span>
          </div>
        </button>
      )}
    </div>
  );
};

export default App;